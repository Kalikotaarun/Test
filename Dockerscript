pipeline {

    agent any
    
    environment {
      docker_repo = 'ec2-13-59-73-13.us-east-2.compute.amazonaws.com:8083'
      /* demo_app_tag = 'Test:dev' */
      TARGETCONTAINER='winfortifysca'
	  /* NUSERNAME='akalikota'
	  NPASSWORD='Deloitte@123' */
	  
    }

    stages { 
    
        stage('Setup') {
        
            steps {
              withCredentials([usernamePassword(credentialsId: '729641e2-ae0a-42ac-ab48-defa894422e0', usernameVariable: 'NUSERNAME', passwordVariable: 'NPASSWORD')]){
                sh '''#!/bin/bash -l
				
				echo "username is $NUSERNAME"
				echo "password is $NPASSWORD"

                git config --global credential.helper cache

                git config --global user.email "${git_repo_user}@dummy.com"

                git config --global user.name "${git_repo_user}"
                
                '''
              }
            }
        }
		
		stage('Pulling Docker Repo') {
            
            steps {
              
               sh '''#!/bin/bash -l

                 echo "Starting Docker Image"
				 
				 echo "login command $NUSERNAME -p $NPASSWORD $docker_repo/repository/devsecopsrepo/"
			 
				 docker login -u $NUSERNAME -p $NPASSWORD $docker_repo/repository/devsecopsrepo/
				 
				 echo "docker pull $docker_repo/repository/devsecopsrepo/winmsbuildv1"
				 docker pull $docker_repo/repository/devsecopsrepo/winmsbuildv1
				 
				 echo 'Listing the images'
				 
				 docker images
				 
				 '''
				 }
			}


        stage('Run SCA') {
            
            steps {
              
               sh '''#!/bin/bash -l

                 docker run --name winfortifysca -v "$WORKSPACE":/workspace -t -d $docker_repo/winmsbuildv1 -language dotnet -projectName dotnet -buildTool msbuild -buildFile /workspace/ArunVSTSApp.sln -projectRoot /workspace -jobName "$JOB_NAME" -buildNumber "$BUILD_NUMBER"
				 docker stop -t 0 winfortifysca
				 docker rm winfortifysca
				 
				 docker system prune -f
                
                 '''
                 
            }
        }

    
    }

    post {
        always {            
            sh '''#!/bin/bash -l
                    echo 'Cleaning up the environment.'
                    
                    set +e
                    docker stop $TARGETCONTAINER
                    docker system prune -f
                    set -e

                    docker build -t $demo_app_tag -f docker/Dockerfile .
        
                '''
        }
        success {
            println('I succeeeded!')
        }
        unstable {
            println('I am unstable :/')
        }
        failure {
            println('I failed :(')
        }
        changed {
            println('Things were different before...')
        }
    }
}

